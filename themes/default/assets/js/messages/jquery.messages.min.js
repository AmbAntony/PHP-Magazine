// +------------------------------------------------------------------------+
// | @author Oscar GarcÃ©s (SoyVillareal)
// | @author_url 1: https://soyvillareal.com
// | @author_url 2: https://github.com/soyvillareal
// | @author_email: hi@soyvillareal.com   
// +------------------------------------------------------------------------+
// | PHP Magazine - The best digital magazine for newspapers or bloggers
// | Licensed under the MIT License. Copyright (c) 2022 PHP Magazine.
// +------------------------------------------------------------------------+
(function(){var e,t,n,i,a,s,o,r,d,l,p,c,m=$(".content_pnuser[data-id="+paper_m.profile_id+"]"),f=$("#btn-pmsend"),h=$("#content-pnnew"),_=function(e,t){return e.attr("disabled",t)};e=$("#content-messages"),t=$("#content-pmtext"),n=$("#content-mform"),i=function(n=!1){(c||n)&&t.animate({scrollTop:e.height()},750)},a=function(e){e.TX&&$(e.EL).find(".item_pntuser").text(e.TX).siblings(".item_pncuser").text(e.CA)},s=function(t,n){var a=e.find(".container_pmdot");a.length>0?a.before(t.HTM):e.append(t.HTM),t.HTM&&i(n)},o=function(){m.removeClass("is_new").find(".content_pninfo").removeClass("hidden")},r=!1,d=!0,l=!0,p=!1,c=!0,t.scrollTop(e.height()).removeClass("pointer-events-none"),r=!0,function(){var r=$("#content-mfreply"),l=$("#content-mffiles"),c=$("#text-message");$("#content-norefor"),function(){var m=$("#content-mfrefi"),h=$("#item-mfrouser"),u=$("#item-mfrmessage"),g=$("#content-mfinputs"),v=$(".disable_before"),C=function(i){var h=new FormData,u=$(".content_mffile"),C=$(".content_mfimage"),k=g.children(),S=c.val();if(k.length>0)k.each(function(e,t){var n=$(t).prop("files");h.append("file_"+e,n[0])});else if(""==$.trim(S))return c.val(""),i&&i.preventDefault(),!1;"on"==paper_m.settings.nodejs&&h.append("socket_id",SOCKET.id),h.append("count_files",k.length),h.append("profile_id",paper_m.profile_id),h.append("text",S),h.append("answered_id",y),h.append("type",w),d=!1,_(v,!0),f.addClass("spinner-is-loading"),$.ajax({url:paper_m.url.send+"?token="+paper_m.token,type:"POST",data:h,contentType:!1,processData:!1,success:function(i){200==i.S?(p=!1,i.CO&&($(i.EL+" .btn_pcdelete").attr("data-id",i.CID).removeClass("unseen hidden"),e.html(""),o()),paper_m.messages_ids.push(i.MID),g.html(""),l.addClass("hidden"),m.addClass("hidden"),r.addClass("hidden"),$(C[0]).addClass("hidden").find("img").attr("src","").attr("alt",""),$(u[0]).addClass("hidden").find("span").text(""),l.children(":not(.hidden)").remove(),n.trigger("reset"),c.attr("rows",1),t.removeAttr("style"),s(i,!0),a(i),_(v,!1),f.removeClass("spinner-is-loading"),d=!0):(_(v,!1),f.removeClass("spinner-is-loading"))}})},k=!0,y=0,w="text";(function(){var e=0,a="";paper_m.enable_msg?(f.click(C),c.focus(function(){var e=$(this);0==e.val().length&&e.prop("baseScrollHeight",e.prop("scrollHeight"))}),c.on("keyup, input",function(){if(!k)return k=!0,!1;var e=$(this);e.attr("rows",1);var n=e.prop("scrollHeight"),a=1+Math.ceil((n-e.prop("baseScrollHeight"))/24),s=m.height(),o=s>0?s+21:s,r=162+o;a<=6&&(r=c.height()+o+(n>=54?n-2:n)),t.css("height","calc(70vh - "+r+"px)"),e.attr("rows",a>6?6:a),i()}),c.keyup(function(t){var n=$(this).val();clearTimeout(e),n.length>0?(n!=a&&(p=!0),a=n,e=setTimeout(function(){p=!1},5e3)):p=!1,13==(t.keyCode||t.which)&&!t.shiftKey&&(n.length>0||g.children().length>0)&&C()}),c.keydown(function(e){var t=$(this),n=e.keyCode||e.which,i=e.shiftKey,a=t.val().length,s=13==n;if(s&&i&&(k=!1),s&&0==a||s&&!i&&a>0)return e.preventDefault(),!1}),c.focus()):$("#item-pnsearch").focus(),$("#btn-mfrclose").click(function(){y=0,l.hasClass("hidden")&&m.addClass("hidden"),r.addClass("hidden"),u.text(""),h.text(""),t.css("height","calc(70vh - "+n.height()+"px)")}),$("#btn-close").click(function(){$(this).parents(".content-alert").addClass("hidden")})})(),function(){var a=$("#item-mfrtuser"),s=function(e,t=!0){e=this==window?e:$(this);var n=$(".btn_pnmoptions[aria-expanded=true]"),i=function(e){return e.attr("aria-expanded",!JSON.parse(e.attr("aria-expanded")))};t&&n.length>0&&i(n),i(e).blur()},o=function(){return $(".btn_pnmoptions[aria-expanded=true]")};$(document).on("click",".btn_pmtreply",function(){var e=$(this),s=e.attr("data-type"),o=e.parents(".content_pmtmessage"),d=h.parent(),p=e.parents(".content_pmt"+("text"==s?"message":s)).find(".item_pmtutext"),f=o.find(".item_pmtext").text();-1!=["file","image"].indexOf(s)&&(f="file"==s?paper_m.word.attached_file:paper_m.word.image),p.length>0?(d.removeClass("hidden"),h.text(p.text()),a.addClass("hidden")):(d.addClass("hidden"),a.removeClass("hidden")),u.text(f),i(),c.focus(),l.hasClass("hidden")&&m.removeClass("hidden"),r.removeClass("hidden"),y=e.attr("data-id"),t.css("height","calc(70vh - "+n.height()+"px)"),w=s}).on("click",".btn_pnmoptions:not(#btn-pnnclose)",s).click(function(e){var t=o();!$(e.target).is(".content_pnmoptions, .content_pnmoptions *")&&t.length>0&&s(t,!1)}),function(){var t=$("body"),n=$("#alert-cdelete"),i=$("#btn-cdelete"),a=$("#alert-cblock"),r=$("#btn-cblock"),d=$("#alert-mdelete"),l=$("#btn-mdelete"),p=$("#alert-mmdelete"),c=$("#btn-mmdelete"),m=function(e){e.addClass("hidden"),t.removeClass("overflow-hidden")},f=function(e=!1,n,i,a){var r=o();i.attr("data-id",n.attr("data-id")),e&&i.attr("data-type",n.attr("data-type")),a.removeClass("hidden"),t.addClass("overflow-hidden"),r.length>0&&s(r,!1)},h=function(){$(d.find(".item_dmtype")[0]).prop("checked",!0)},u=function(e){_(e.removeClass("spinner-is-loading"),!1)},g=function(e){_(e.addClass("spinner-is-loading"),!0)};$(document).on("click",".btn_pmtdelete",function(){f(!0,$(this),l,d)}).on("click",".btn_pmtmdelete",function(){f(!0,$(this),c,p)}).on("click",".btn_pcdelete",function(){f(!0,$(this),i,n)}).on("click",".btn_pcblock",function(){f(!0,$(this),r,a)}),$("#btn-cdcancel").click(function(){m(n)}),$("#btn-cbcancel").click(function(){m(a)}),$("#btn-mcancel").click(function(){m(d),h()}),$("#btn-mmcancel").click(function(){m(p)}),r.click(function(){var e=$(this),t=e.attr("data-id");g(e),$.post(paper_m.url.block+"?token="+paper_m.token,{profile_id:t},function(t){200==t.S?window.location.reload():u(e)})}),i.click(function(){var e=$(this),t=e.attr("data-id");g(e),$.post(paper_m.url.delete_chat+"?token="+paper_m.token,{chat_id:t},function(t){200==t.S?window.location.reload():u(e)})}),l.click(function(){var t,n=$(this),i=n.attr("data-type"),a=n.attr("data-id"),s=d.find(".item_dmtype:checked").val(),o="message";g(n),$.post(paper_m.url.delete_both_message+"?token="+paper_m.token,{id:a,for:s,type:i},function(r){if(200==r.S)if("text"!=i&&(o=i),t=$(".content_pmt"+o+"[data-id="+a+"]"),h(),m(d),u(n),"all"==s)e.find(".item_pmtmmessage[data-id="+a+"][data-type="+i+"]").replaceWith(r.HT),t.replaceWith(r.HT);else{if(1==r.DA&&"message"!=o){var l=t.parents(".content_pmtmessage");l.next(".item_pmttime").remove(),l.remove()}else{var p=t.next(),c=p.is(".content_pmtimages");l=c?p:t,l.next(".item_pmttime").remove(),c&&"text"!=i&&p.remove(),t.remove()}e.find(".item_pmtmessage[data-id="+a+"][data-type="+i+"]").remove()}else u(n)})}),c.click(function(){var e=$(this),t=e.attr("data-type"),n=e.attr("data-id");g(e),$.post(paper_m.url.delete_me_message+"?token="+paper_m.token,{id:n,type:t},function(i){if(200==i.S){var a="text"!=t?t:a,s="[data-id="+n+"]",o=$(".content_pmt"+a+s+", .content_pmtmessage"+s+", .item_pmtmessage"+s+"[data-type="+t+"]");if(1==i.DA&&"message"!=a){var r=o.parents(".content_pmtmessage");r.next(".item_pmttime").remove(),r.remove()}else{var d=o.next(),l=d.is(".content_pmtimages");r=l?d:o,r.next(".item_pmttime").remove(),l&&"text"!=t&&d.remove(),o.remove()}m(p),u(e)}else u(e)})})}()}()}(),function(){var e=$("#btn-mffile"),a=$("#content-mfrefi"),s=$("#content-mfinputs"),o=$("#btn-pmsend"),d=function(t,n=!1){var a=t.prop("files");if(a&&a[0]){var s=new FileReader,r=function(a){var s=$($(".content_mfimage")[0]),r=$(".item_mffile"),d=s;n&&(d=s.clone(),s.val("")),d.removeClass("hidden").find("img").attr("src",a).attr("alt",a[0].name),r.length>0?d.insertBefore(l.children().first()):n&&l.prepend(d),_(e,!1).removeClass("spinner-is-loading"),c(t,"image"),i(),o.focus()};s&&s.readAsDataURL?(s.readAsDataURL(a[0]),$(s).on("load",function(){r(s.result)})):window.URL.createObjectURL&&r(window.URL.createObjectURL(a[0]))}return!1},p=function(e,t=!1){var n=$($(".content_mffile")[0]),a=$(".item_mffile"),s=n;t&&(s=n.clone(),n.val()),s.removeClass("hidden").find("span").text(e[0].name),a.length>0?s.insertBefore(l.children().first()):t&&l.prepend(s),i()},c=function(e,i){e.addClass("is_"+i),l.removeClass("hidden"),a.removeClass("hidden"),t.css("height","calc(70vh - "+n.height()+"px)"),o.focus()};e.click(function(){var e=s.children(),t=function(){s.prepend($('<input class="item_mffile hidden" type="file"/>').trigger("click"))};if(e.length>0){var n=e.first();n.prop("files").length>0?t():n.trigger("click")}else t()}),$(document).on("change",".item_mffile",function(t){var n=$(this),i=n.prop("files");if(i[0].size>paper_m.file_size_limit)return $("#alert-limit").removeClass("hidden"),t.preventDefault(),!1;0==s.find(".item_mffile").length&&n.next().children().replaceWith('<svg class="icon-z vertical-middle" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>'+paper_m.word.more_files+'</title><path fill="currentColor" d="M13,13 L13,20 C13,20.5522847 12.5522847,21 12,21 C11.4477153,21 11,20.5522847 11,20 L11,13 L4,13 C3.44771525,13 3,12.5522847 3,12 C3,11.4477153 3.44771525,11 4,11 L11,11 L11,4 C11,3.44771525 11.4477153,3 12,3 C12.5522847,3 13,3.44771525 13,4 L13,11 L20,11 C20.5522847,11 21,11.4477153 21,12 C21,12.5522847 20.5522847,13 20,13 L13,13 Z"></path></svg>'),-1!=["image/png","image/jpeg","image/gif"].indexOf(i[0].type)?(_(e,!0).addClass("spinner-is-loading"),$(".item_mffile.is_image").length>0?d(n,!0):d(n)):($(".item_mffile.is_file").length>0?p(i,!0):p(i),c(n,"file"))}).on("click",".btn_mffile",function(){var e=s.children().first();0==e.prop("files").length&&e.remove();var i=$(this),o=l.children(":not(.hidden)"),d=i.parents(".content_mfimage, .content_mffile"),p=o.index(d),c=s.children().length,m=$($(".item_mffile")[p]),f=s.find(".item_mffile.is_image"),h=s.find(".item_mffile.is_file");1!=f.length&&1!=h.length||(d.addClass("hidden"),1==f.length&&d.find("img").attr("src","").attr("alt",""),1==h.length&&d.find("span").text("")),(f.length>1&&m.hasClass("is_image")||h.length>1&&m.hasClass("is_file"))&&d.remove(),1==c&&(r.hasClass("hidden")&&a.addClass("hidden"),l.addClass("hidden")),m.remove(),t.css("height","calc(70vh - "+n.height()+"px)")})}()}(),function(){var n=$("#content-pnchats"),i=$("#content-pmntspinner"),f=$("#content-pnuspinner"),_=$("#container-pnchats"),u=$("#content-norefor"),g=$("#item-pnsearch"),v=$("#btn-mdown"),C=g.prev(),k=function(){c=!0,v.removeAttr("style")},y="";t.scroll(function(){var n=e.height();t.scrollTop()+$(window).height()<n?(c=!1,v.css("bottom",15)):k(),r&&t.scrollTop()<=60&&(i.removeClass("hidden"),$.post(paper_m.url.fetch+"?token="+paper_m.token,{profile_id:paper_m.profile_id,messages_ids:JSON.stringify(paper_m.messages_ids),type:"first"},function(n){if(200==n.S){var a=e.height();t.addClass("pointer-events-none"),i.addClass("hidden"),e.prepend(n.HTM),n.MIDS&&(paper_m.messages_ids=n.MIDS),t.animate({scrollTop:e.height()-a},100,function(){r=!0,t.removeClass("pointer-events-none")})}else i.addClass("hidden")}),r=!1)}),_.scroll(function(){var e=n.height();l&&_.scrollTop()+_.height()>=e-e/100*10&&(l=!1,f.removeClass("hidden"),$.post(paper_m.url.fetch+"?token="+paper_m.token,{profiles_ids:JSON.stringify(paper_m.profiles_ids),type:"users",keyword:y},function(e){200==e.S?(l=!0,f.addClass("hidden"),f.before(e.HTU),e.UIDS&&(paper_m.profiles_ids=e.UIDS)):f.addClass("hidden")}))}),v.click(function(){t.scrollTop(e.height()),k()}),g.on("keyup, keydown, input",function(){var e=g.val();paper_m.profiles_ids=[],d=l=!1,C.addClass("spinner-is-loading"),$.post(paper_m.url.search_chats+"?token="+paper_m.token,{profile_id:paper_m.profile_id,profiles_ids:JSON.stringify(paper_m.profiles_ids),keyword:e},function(e){200==e.S?($("li").remove(".content_pnuser"),u.addClass("hidden"),n.removeClass("hidden"),C.removeClass("spinner-is-loading"),h.after(e.HTU),e.UIDS&&(paper_m.profiles_ids=e.UIDS),y=e.KW,d=l=!0):204==e.S?(y="",n.addClass("hidden"),u.html(e.HT).removeClass("hidden"),y="",C.removeClass("spinner-is-loading")):(y="",u.addClass("hidden"),n.removeClass("hidden"),C.removeClass("spinner-is-loading"))})}),function(){var i=function(e){if(200==e.S){if(200==e.S)for(var t=0;t<e.TPS.length;t++){var n=e.TPS[t];$(n.EL).find(".item_pntuser").text(n.TX)}e.DL&&l()}},r=function(n,i){var a=e.find(".container_pmdot");i?(0==a.length&&e.append(n.HTT),t.scrollTop(e.height())):(a.remove(),p=!1)},l=function(){e.find(".container_pmdot").remove()};if("off"==paper_m.settings.nodejs)setInterval(function(){var t=n.find(".content_nomgs"),i=paper_m.messages_ids,l=paper_m.profiles_ids,c={profile_id:paper_m.profile_id,type:"last",keyword:y,typing:p};d&&(i.length>0&&(c={profile_id:paper_m.profile_id,messages_ids:JSON.stringify(i),type:"last",keyword:y,typing:p}),l.length>0&&(c={profile_id:paper_m.profile_id,last_cupdate:paper_m.last_cupdate,profiles_ids:JSON.stringify(l),messages_ids:JSON.stringify(i),type:"last",keyword:y,typing:p}),$.post(paper_m.url.fetch+"?token="+paper_m.token,c,function(n){200==n.S&&(r(n,!n.HTM&&n.HTT),n.UIDS&&(paper_m.profiles_ids=n.UIDS,paper_m.last_cupdate=n.LCU),n.HTM&&e.find(".content_nomgs").length>0&&e.html(""),n.HTU&&t.length>0&&t.remove(),!m.hasClass("is_new")&&h.after(n.HTU),n.MIDS&&(paper_m.messages_ids=n.MIDS,o()),s(n,!1),n.US&&$.each(n.US,function(e,t){a(t),t.LU&&$(t.EL).find("a").addClass("unseen")}),n.MS&&$.each(n.MS,function(e,t){var n="[data-id="+t.ID+"]",i=$(".content_pmtmessage"+n+", .item_pmtmmessage"+n);!i.hasClass("content-pmtwdeleted")&&i.replaceWith(t.HTG)}),n.FS&&$.each(n.FS,function(e,t){var n=$(".content_pmt"+t.TP+"[data-id="+t.ID+"]");!n.hasClass("content-pmtwdeleted")&&n.replaceWith(t.HTF)}))}))},2e3),setInterval(function(){$.post(paper_m.url.delete_my_typings+"?token="+paper_m.token,{profile_id:paper_m.profile_id},i)},2e4);else{var c=function(e){200==e.S&&(e.UID&&(paper_m.profiles_ids.push(e.UID),paper_m.last_cupdate=e.LCU),!m.hasClass("is_new")&&h.after(e.HTU),a(e),o())},f=function(t){200==t.S&&t.PID==paper_m.profile_id&&(t.MID&&paper_m.messages_ids.push(t.MID),e.find(".content_nomgs").length>0&&e.html(""),s(t,!0),null!=t.DLD&&(l(),SOCKET.emit("setInmseen",{message_id:t.MID})))};SOCKET.on("setOutichat",c),SOCKET.on("setOutochat",c),SOCKET.on("setOutomessage",f),SOCKET.on("setOutimessage",f),SOCKET.on("setOutupchat",function(e){a(e),e.LU&&$(e.EL).find("a").addClass("unseen")}),setInterval(function(){SOCKET.emit("setIntyping",{profile_id:paper_m.profile_id,typing:p})},2e3),SOCKET.on("setOutdMytyping",i),SOCKET.on("setOuttyping",function(e){200==e.S&&e.PID==paper_m.profile_id&&r(e,!e.DL)}),SOCKET.on("setOutttyping",function(e){200==e.S&&$(e.EL).find(".item_pntuser").text(e.TX)})}}()}(),function(){var e=$("#container-messages"),t=$("#container-pmhead-one"),n=$("#container-pmhead-two"),i=$("#container-pnmessage"),a=$("#content-pmsspinner"),s=$("#content-pmsearch"),o=$("#btn-pmnew svg"),r=$("#item-pmsearch"),d=function(){var i="<title>"+paper_m.word.search+'</title><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>';n.hasClass("hidden")?(i="<title>"+paper_m.word.close+'</title><path fill="none" stroke="currentColor" stroke-width="2" d="M3,3 L21,21 M3,21 L21,3"></path>',r.focus()):(r.val("").blur(),s.html("")),o.html(i),e.toggleClass("hidden"),t.toggleClass("hidden"),n.toggleClass("hidden"),h.toggleClass("hidden"),m.find("a").toggleClass("active"),p()},l=function(){a.addClass("hidden").next().removeClass("hidden")},p=function(){i.toggleClass("hide-mobile").next().toggleClass("hide-mobile"),window.history.pushState({state:"new"},"",paper_m.url.messages)},c=function(e){r.attr("aria-expanded",e)},f=paper_m.enable_msg;r.keyup(function(){a.removeClass("hidden"),s.addClass("hidden"),$.post(paper_m.url.search_users+"?token="+paper_m.token,{keyword:r.val()},function(e){200==e.S?(l(),c(!0),s.html(e.HT)):204==e.S?(l(),c(!1),s.html(e.HT)):(l(),c(!1),s.html(""))})}),$(".btn_mback").click(function(){f?p():d(),f=!1}),$("#btn-pmnew, #btn-pnnclose").click(d)}()})(paper_m);